var FS = require('fs');
var PATH = require('path');
var mkdir = require('util-mkdir');
var mv = require('util-mv');


module.exports = htpl2js;


var __type = /\.htpl$/;


/**
 * @param	{string}	src		源文件
 * @param	{string}	dest	输出文件的路径
 * @param	{regexp}	type	匹配的文件格式
 */
function htpl2js(src, dist, type){
	type && type instanceof RegExp ? __type = type : null;
	// make sure dist is existed
	mkdir(PATH.dirname(dist));

	
	//===========
	// log time
	//===========
	var start = new Date();
	
	
	compareSrc2Dist(src, dist);
	compareDist2Src(dist, src);
	
	
	//===========
	// log time
	//===========
	var end = new Date();
	console.log("== HTPL2JS TASK Total time: " + (end.getTime() - start.getTime()) + " ms");
	console.log("----------------------------------------");
	
	
	function compareSrc2Dist(from, to){
		var ll = FS.readdirSync(from);
		ll.forEach(function(name){
			var fpath = PATH.join(from, name);
			var tpath = PATH.join(to, name);
			if(FS.statSync(fpath).isDirectory()){
				compareSrc2Dist(fpath, tpath);
				mkdir(tpath);
			}else{
				if(__type.test(name)){
					FS.writeFileSync(tpath + '.js', "define('" + FS.readFileSync(fpath, 'utf-8').replace(/'/g, "\\'").replace(/\r\n|\t/g, '') + "')", 'utf-8');
				}
			}
		})
	}
	
	function compareDist2Src(from, to){
		var ll = FS.readdirSync(from);
		ll.forEach(function(name){
			var fpath = PATH.join(from, name);
			var tpath = PATH.join(to, name);
			if(FS.statSync(fpath).isDirectory()){
				compareDist2Src(fpath, tpath);
			}else{
				if(/\.htpl\.js$/.test(name)){
					tpath = tpath.replace(/\.js$/, '');
					mv(tpath, fpath);
				}
			}
		})
	}
}