#!/bin/bash
CMD=$(eval whereis inotifywait)
CMD=${CMD:13}

NODE=$(eval whereis node)
NODE=${NODE:6}

BASE=$(cd `dirname $0`; pwd)
INIT=${BASE}"/init.js"
EXEC=${BASE}"/exec.js"
CONF=${BASE}"/run.conf"

KILL=${BASE}"/run.sh"
eval $KILL

# read config like:
#
if [ -n "$1" ];then
	source $1
else
	source $CONF
fi

# trigger all files' watched event
eval $NODE $INIT $BUILDCONF

# trigger inotify
eval $CMD -qmre modify,create,delete,move $SRC | while read DIR EVENT FILE
do
eval $NODE $EXEC $BUILDCONF $DIR $FILE $EVENT
done &

# record pid
pid=$(($!-1))
mkdir -p __inotify_pid
echo $pid > __inotify_pid/log.pid